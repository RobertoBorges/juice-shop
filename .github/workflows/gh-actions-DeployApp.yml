name: Juiceshop DevSecOps App Deployment

on:
  push:
    branches:
    - none

workflow_dispatch:

permissions:
      id-token: write
      contents: read

jobs:
  Build_Stage_Build:
    name: Build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - # "Note: the 'AZURE_CLIENT_ID' and 'AZURE_TENANT_ID' secret is required to be added into GitHub Secrets. See this blog post for details: https://samlearnsazure.blog/2019/12/13/github-actions/"
      name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        allow-no-subscriptions: true

    - uses: azure/cli@v1.0.0
      with:
        inlineScript: 
          echo 'listing azure resources'

          az account show 

          az resource list --subscription (az account show --query 'id' --output tsv)

          az account set --subscription (az account show --query 'id' --output tsv)

          sudo docker build -t ${{ secrets.CONTAINERREGISTRY }}.azurecr.io/devsecops:${{ github.run_id }} .

          az acr login -n ${{ secrets.CONTAINERREGISTRY }}

          docker push ${{ secrets.CONTAINERREGISTRY }}.azurecr.io/devsecops:${{ github.run_id }}
        azcliversion: latest

  Deploy_Dev_Stage_Deploy_to_Dev:
    # 'Note: Azure DevOps strategy>runOnce does not have an equivalent in GitHub Actions yet, and only the deploy steps are transferred to steps'
    name: Deployment to development environment
    runs-on: ubuntu-latest
    needs:
    - Build_Stage_Build
    environment:
      name: Development
    steps:
    - # "Note: the 'AZURE_CLIENT_ID' and 'AZURE_TENANT_ID' secret is required to be added into GitHub Secrets. See this blog post for details: https://samlearnsazure.blog/2019/12/13/github-actions/"
      name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        allow-no-subscriptions: true
    
    - uses: azure/appservice-settings@v1
      with:
        app-name: '${{ secrets.DEVAPPNAME }}'
        general-settings-json: '{"linuxFxVersion": "DOCKER|${{ secrets.CONTAINERREGISTRY }}.azurecr.io/devsecops:${{ github.run_id }}"}' 

    - uses: Azure/cli@v1.0.0
      with:
        inlineScript: az webapp restart --resource-group ${{ secrets.DEVRESOURCEGROUP }}  --name ${{ secrets.DEVAPPNAME }} 

  Deploy_Prod_Stage_Deploy_to_Prod:
    # 'Note: Azure DevOps strategy>runOnce does not have an equivalent in GitHub Actions yet, and only the deploy steps are transferred to steps'
    name: Deployment to production environment
    runs-on: ubuntu-latest
    needs:
    - Deploy_Dev_Stage_Deploy_to_Dev
    environment:
      name: Production
    steps:
    - # "Note: the 'AZURE_CLIENT_ID' and 'AZURE_TENANT_ID' secret is required to be added into GitHub Secrets. See this blog post for details: https://samlearnsazure.blog/2019/12/13/github-actions/"
      name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        allow-no-subscriptions: true

    
    - uses: azure/appservice-settings@v1
      with:
        app-name: '${{ secrets.PRODAPPNAME }}'
        general-settings-json: '{"linuxFxVersion": "DOCKER|${{ secrets.CONTAINERREGISTRY }}.azurecr.io/devsecops:${{ github.run_id }}"}' 

    - uses: Azure/cli@v1.0.0
      with:
        inlineScript: az webapp restart --resource-group ${{ secrets.PRODRESOURCEGROUP }}  --name ${{ secrets.PRODAPPNAME }} 
